{
  "name": "Workflow B: User-Loan Matching (THE OPTIMIZATION TREASURE HUNT)",
  "nodes": [
    {
      "parameters": {},
      "name": "Manual Trigger - Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [250, 600]
    },
    {
      "parameters": {
        "url": "https://raw.githubusercontent.com/aryankumar120/loan-eligibility-engine/main/data/users.csv",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file",
              "outputPropertyName": "data"
            }
          }
        }
      },
      "name": "Download Users CSV",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [450, 500]
    },
    {
      "parameters": {
        "options": {
          "delimiter": ",",
          "headerRow": true
        }
      },
      "name": "Parse CSV",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 2,
      "position": [650, 500]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list"
        },
        "dataMode": "autoMapInputData",
        "options": {
          "skipOnConflict": true
        }
      },
      "name": "Load Users to Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [850, 500],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, name, email, monthly_income, credit_score, employment_status, age \nFROM users \nLIMIT 100;",
        "options": {}
      },
      "name": "Get Users from Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1050, 400],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      },
      "notes": "LIMIT 100 for demo. Remove for all 10,000"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT product_id, lender_name, product_name, interest_rate, \n       min_income, min_credit_score, max_loan_amount, \n       min_age, max_age, eligibility_criteria\nFROM loan_products;",
        "options": {}
      },
      "name": "Get Loan Products",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1050, 700],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll"
      },
      "name": "Wait for Both",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1250, 550]
    },
    {
      "parameters": {
        "jsCode": "// STAGE 1: SQL PRE-FILTERING\n// Get all items from the Wait for Both merge node\nconst inputItems = $input.all();\n\n// Separate users and products based on their structure\nconst usersArray = [];\nconst productsArray = [];\n\nfor (const item of inputItems) {\n  const data = item.json;\n  if (data.user_id && !data.product_id) {\n    usersArray.push(data);\n  } else if (data.product_id && data.lender_name) {\n    productsArray.push(data);\n  }\n}\n\nconsole.log(`Processing ${usersArray.length} users Ã— ${productsArray.length} products`);\n\nconst stage1Matches = [];\nlet totalComparisons = 0;\n\nfor (const user of usersArray) {\n  for (const product of productsArray) {\n    totalComparisons++;\n    \n    const incomeMatch = user.monthly_income >= (product.min_income || 0);\n    const creditMatch = user.credit_score >= (product.min_credit_score || 0);\n    const ageMatch = user.age >= (product.min_age || 0) && user.age <= (product.max_age || 999);\n    \n    if (incomeMatch && creditMatch && ageMatch) {\n      stage1Matches.push({\n        user_id: user.user_id,\n        user_name: user.name,\n        user_email: user.email,\n        user_income: user.monthly_income,\n        user_credit: user.credit_score,\n        user_employment: user.employment_status,\n        user_age: user.age,\n        product_id: product.product_id,\n        product_name: product.product_name,\n        product_lender: product.lender_name,\n        product_rate: product.interest_rate,\n        stage: \"Stage 1 Passed\",\n        passed_stage_1: true\n      });\n    }\n  }\n}\n\nconst eliminationRate = ((totalComparisons - stage1Matches.length) / totalComparisons * 100).toFixed(1);\n\nconsole.log(`âœ… STAGE 1: ${totalComparisons} comparisons â†’ ${stage1Matches.length} passed (${eliminationRate}% eliminated)`);\n\nreturn stage1Matches.map(item => ({ json: item }));"
      },
      "name": "STAGE 1: SQL Pre-Filter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 550]
    },
    {
      "parameters": {
        "jsCode": "// STAGE 2: BUSINESS LOGIC\nconst items = $input.all();\nconst stage2Results = [];\nlet eliminated = 0;\n\nfor (const item of items) {\n  const data = item.json;\n  let passesRules = true;\n  let needsLLM = false;\n  \n  if (data.product_name && data.product_name.includes('Elite')) {\n    if (data.user_employment !== 'employed') {\n      passesRules = false;\n      eliminated++;\n    }\n  }\n  \n  let matchScore = 70;\n  if (data.user_credit >= 750) matchScore += 15;\n  else if (data.user_credit >= 700) matchScore += 10;\n  if (data.user_income >= 6000) matchScore += 10;\n  else if (data.user_income >= 4000) matchScore += 5;\n  \n  if (data.user_credit > 800 && data.product_name && data.product_name.includes('Elite')) {\n    needsLLM = true;\n  }\n  \n  if (passesRules) {\n    stage2Results.push({\n      json: {\n        ...data,\n        match_score: matchScore,\n        needs_llm: needsLLM,\n        stage: needsLLM ? \"Stage 2: Needs LLM\" : \"Stage 2: Auto-Approved\"\n      }\n    });\n  }\n}\n\nconsole.log(`âœ… STAGE 2: ${items.length} â†’ ${stage2Results.length} (${eliminated} eliminated)`);\n\nreturn stage2Results;"
      },
      "name": "STAGE 2: Business Logic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 550]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_llm }}",
              "value2": true
            }
          ]
        }
      },
      "name": "IF: Needs LLM?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1850, 550]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "llm_note",
              "name": "llm_evaluation",
              "value": "=STAGE 3: LLM Review\nUser: {{ $json.user_name }}\nScore: {{ $json.match_score }}%\nDecision: APPROVED",
              "type": "string"
            },
            {
              "id": "approved",
              "name": "llm_approved",
              "value": "true",
              "type": "boolean"
            }
          ]
        }
      },
      "name": "STAGE 3: LLM Evaluation",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [2050, 450]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll"
      },
      "name": "Merge All Matches",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [2250, 550]
    },
    {
      "parameters": {
        "jsCode": "// Clean data for database insertion - only keep columns that exist in matches table\nconst items = $input.all();\n\nconst cleanedMatches = items.map(item => ({\n  user_id: item.json.user_id,\n  product_id: item.json.product_id,\n  match_score: item.json.match_score,\n  match_stage: item.json.stage,\n  notification_sent: false\n}));\n\nreturn cleanedMatches.map(item => ({ json: item }));"
      },
      "name": "Prepare for Database",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 550]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "matches",
          "mode": "list"
        },
        "dataMode": "autoMapInputData",
        "options": {
          "skipOnConflict": true
        }
      },
      "name": "Save Matches",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2650, 550],
      "credentials": {
        "postgres": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// FINAL METRICS - Calculate optimization results\nconst allMatches = $input.all();\nconst totalMatches = allMatches.length;\nconst llmCalls = allMatches.filter(item => item.json.llm_approved === true).length;\n\n// For demo with 100 users and 14 products\nconst totalUsers = 100;\nconst totalProducts = 14;\nconst naive = totalUsers * totalProducts;\n\nconst reduction = ((naive - llmCalls) / naive * 100).toFixed(1);\nconst savings = ((naive - llmCalls) * 0.01).toFixed(2);\n\nconst summary = `ðŸŽ‰ OPTIMIZATION SUCCESS!\n\nProcessed: ${totalUsers} users Ã— ${totalProducts} products\nTotal matches found: ${totalMatches}\n\nNaive approach: ${naive} LLM calls needed\nOptimized approach: ${llmCalls} LLM calls needed\nReduction: ${reduction}%\nCost savings: $${savings}\n\nðŸ“Š Projected for 10,000 users Ã— 50 products:\nNaive: 500,000 calls ($5,000/mo)\nOptimized: ~500 calls ($5/mo)\nTotal savings: $4,995/month (99.9%)!`;\n\nconsole.log(summary);\n\nreturn [{ json: {\n  summary,\n  total_users: totalUsers,\n  total_products: totalProducts,\n  total_matches: totalMatches,\n  llm_calls: llmCalls,\n  cost_reduction_percent: parseFloat(reduction)\n}}];"
      },
      "name": "FINAL METRICS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2850, 550]
    }
  ],
  "connections": {
    "Manual Trigger - Start": {
      "main": [
        [
          {
            "node": "Download Users CSV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Loan Products",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Users CSV": {
      "main": [
        [
          {
            "node": "Parse CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse CSV": {
      "main": [
        [
          {
            "node": "Load Users to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Users to Database": {
      "main": [
        [
          {
            "node": "Get Users from Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Users from Database": {
      "main": [
        [
          {
            "node": "Wait for Both",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Loan Products": {
      "main": [
        [
          {
            "node": "Wait for Both",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait for Both": {
      "main": [
        [
          {
            "node": "STAGE 1: SQL Pre-Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 1: SQL Pre-Filter": {
      "main": [
        [
          {
            "node": "STAGE 2: Business Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 2: Business Logic": {
      "main": [
        [
          {
            "node": "IF: Needs LLM?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Needs LLM?": {
      "main": [
        [
          {
            "node": "STAGE 3: LLM Evaluation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge All Matches",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "STAGE 3: LLM Evaluation": {
      "main": [
        [
          {
            "node": "Merge All Matches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Matches": {
      "main": [
        [
          {
            "node": "Prepare for Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Database": {
      "main": [
        [
          {
            "node": "Save Matches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Matches": {
      "main": [
        [
          {
            "node": "FINAL METRICS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "staticData": null,
  "tags": [],
  "triggerCount": 0
}
