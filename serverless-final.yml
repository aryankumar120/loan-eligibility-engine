service: loan-csv-handler

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.9
  region: ap-south-1
  stage: dev

  environment:
    DB_HOST: loan-eligibility-db-v2.cd04gweugz24.ap-south-1.rds.amazonaws.com
    DB_PORT: 5432
    DB_NAME: loan_eligibility
    DB_USER: postgres
    DB_PASSWORD: ${env:DB_PASSWORD}
    CSV_BUCKET: loan-csv-uploads-ak120-final

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
          Resource: "arn:aws:s3:::loan-csv-uploads-ak120-final/*"
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource: "arn:aws:s3:::loan-csv-uploads-ak120-final"

functions:
  getUploadUrl:
    handler: lambda/get_upload_url.handler
    timeout: 30
    memorySize: 256
    environment:
      CSV_BUCKET: loan-csv-uploads-ak120-final
    events:
      - httpApi:
          path: /upload-url
          method: get
      - httpApi:
          path: /upload-url
          method: options

  processCSV:
    handler: lambda/process_csv.lambda_handler
    timeout: 300
    memorySize: 512
    environment:
      N8N_WEBHOOK_URL: ${env:N8N_WEBHOOK_URL, ''}
    layers:
      - Ref: PythonRequirementsLambdaLayer
    events:
      - s3:
          bucket: loan-csv-uploads-ak120-final
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - suffix: .csv

package:
  individually: false
  patterns:
    - '!node_modules/**'
    - '!.venv/**'
    - '!package-lock.json'
    - 'lambda/**'

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: true
    layer: true
    pythonBin: python3
